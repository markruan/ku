<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title></title>
    <link rel="stylesheet" type="text/css" href="../../css/Hui.css" />
    <link rel="stylesheet" type="text/css" href="http://at.alicdn.com/t/font_1466120150_564351.css">
    <script type="text/javascript" src="../../script/vue.min.js"></script>
    <style type="text/css">
        .bgg {
            background-image: url(../../image/hd2.jpg);
            background-position: right bottom, left top;
        }

        #footer {
            position: fixed;
            bottom: 0px;
        }

        {
            height: 52px;
            border-top: 3px solid #e6e6e6;
            -webkit-background-size: cover;
            background-size: cover;
            position: relative;
            width: 100%;
        }

        span {
            position: absolute;
            white-space: nowrap;
            background-repeat: no-repeat;
            background-position: center;
            -webkit-background-size: contain;
            background-size: contain;
        }

        .radio.active {
            background-color: rgba(0, 0, 0, .2);
        }

        .radio .inner {
            padding-left: 62px;
            max-width: 60%;
            color: #fff;
            font-size: 14px;
            line-height: 50px;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            background: url(../../image/scheduleliving2.png) no-repeat 48px center;
            -webkit-background-size: 25px 13px;
            background-size: 25px 13px;
        }

        .menu,
        .play,
        .xin,
        .pause,
        .buffer,
        .next {
            width: 36px;
            height: 36px;
            top: 6px;
        }

        .menu {
            left: 10px;
            /*background-image: url(../../image/miniplay_menu.png);*/
        }

        .menu.active {
            /*background-image: url(../../image/miniplay_menu_s.png);*/
        }

        .play {
            right: 56px;
            background-image: url(../../image/miniplay_play.png);
        }

        .xin {
            right: 10px;
            background-image: url(../../image/ic_channel_addfav.png);
        }

        .xin.active {
            right: 10px;
            background-image: url(../../image/ic_play_faved.png);
        }

        .play.active {
            background-image: url(../../image/miniplay_play_s.png);
        }

        .pause {
            right: 56px;
            background-image: url(../../image/miniplay_pause.png);
        }

        .pause.active {
            background-image: url(../../image/miniplay_pause_s.png);
        }

        .buffer {
            background-image: none;
            right: 56px;
        }

        @-webkit-keyframes rotate {
            from {
                -webkit-transform: rotate(0deg);
            }
            to {
                -webkit-transform: rotate(360deg);
            }
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .buffer:before {
            content: '';
            width: 100%;
            height: 100%;
            display: inline-block;
            background: url(../../image/miniplay_buffer.png) no-repeat center;
            -webkit-background-size: contain;
            background-size: contain;
            -webkit-animation: rotate 4s linear infinite;
            animation: rotate 4s linear infinite;
        }

        .next {
            right: 10px;
            background-image: url(../../image/miniplay_next.png);
        }

        .next.active {
            background-image: url(../../image/miniplay_next_s.png);
        }

        .minbar_img {
            width: 42px;
            height: 42px;
            border-radius: 21px;
        }
    </style>
</head>

<body class="">
    <div id="app" v-clock>
        <header class="H-header  bgg H-border-vertical-bottom-after" id="header">
            <span tapmode="" onclick="H.openSlidPane();" class="H-icon H-position-relative H-display-block H-float-left H-vertical-middle H-theme-font-color-white H-padding-horizontal-both-10 H-z-index-1000"><i class="H-iconfont H-icon-more-menu H-font-size-18 H-vertical-middle"></i></span>
            <div class="H-header-title H-center-all H-font-size-18 H-text-show-row-1 H-theme-font-color-white H-position-absolute H-width-100-percent ">
                <div class="H-search H-flexbox-horizontal H-box-sizing-border-box  H-theme-background-color-transparent H-border-radius-3 H-overflow-hidden" style="width: 70%; height: 35px">
                    <input tapmode @click="openS()" name="keyword" id="search" placeholder="Search...." class="H-border-none H-theme-background-color-transparent H-flex-item H-font-size-16 H-padding-horizontal-both-10 H-padding-vertical-both-2 H-vertical-align-middle H-theme-border-color-ccc H-theme-font-color-white"
                        style="border-width: 0 0 1px  0; ">
                </div>
            </div>
            <span class="H-icon H-position-relative H-display-block H-float-right H-vertical-middle H-theme-font-color-white H-padding-horizontal-both-5 H-z-index-1000" tapmode @click="openS()"><i  class="H-iconfont H-icon-search H-font-size-18 H-vertical-middle H-margin-horizontal-right-15"></i></span>
            <div class="H-flexbox-horizontal H-theme-background-color-white" id="tag">
                <div tapmode="" @click="setPage(0, '../../html/page/page_frm.html');" class="H-flex-item H-center-all H-theme-font-color-red H-padding-vertical-both-10 H-theme-border-color-white  H-font-size-16 H-theme-border-color-52ace5 H-theme-font-color-52ace5 H-theme-border-color-red H-theme-font-color-red"
                    style="border-width: 0 0 1px  0">
                    精选
                </div>
                <div tapmode="" @click="setPage(1, '../../html/quan/index.html');" class="H-flex-item H-center-all H-theme-font-color-666 H-padding-vertical-both-10 H-theme-border-color-white  H-font-size-16" style="border-width: 0 0 1px  0">
                    歌单
                </div>
            </div>
        </header>
        <div class="H-main H-flex-item"></div>
        <footer class="H-footer H-flexbox-horizontal bgg H-border-vertical-top-after" id="footer">
            <div id="miniplayer">
                <span class="menu " tapmode="active" @click="openPlayer()">
                <img :src="music_img_min" alt=" " class="minbar_img H-paper-2">
                </span>
                <div id="str6" class="radio" tapmode="active">
                    <!--onclick="openRadioDetail()"openPlayer()-->
                    <div tapmode @click="openPlayer()" class="inner" id="title" style="overflow-x:hidden;white-space:nowrap;width: 250px;">
                        {{songName}}-{{artists}}
                    </div>
                </div>
                <span id="pp" :class="isPlaying?'pause':'play'" tapmode="focus" data-click="0" @click="switchmusic()" data-mp3=""></span>
                <span class="next" tapmode="active" @click="playNext"></span>
            </div>
        </footer>
    </div>
</body>
<script type="text/javascript" src="../../script/H.js"></script>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/music.js"></script>
<script type="text/javascript" src="../../script/lyric.js"></script>
<script type="text/javascript" src="../../script/play.js"></script>

<script type="text/javascript">
    var playid = $api.byId('pp')
    var music, audioCover
    music = new neteaseMusic()
    H.ready(function() {
        H.dblclickToCloseApp();
        var fs = api.require('fs');
        fs.createDir({
            path: 'fs://cache'
        }, function(ret, err) {
            if (ret.status) {
                // /song/detail?ids=
            } else {
                // alert(JSON.stringify(err));
            }
        });
        app.initmlist() //初始化播放BAR,还没弄好
        isOnLineStatus(function(is_true, line_type) {
            if (is_true) {
                if (line_type == '3g' || line_type == '2g') {
                    app.pause()
                    api.toast({
                        msg: '网络信号不稳定，请稍后再试',
                        duration: 2000,
                        location: 'bottom'
                    });

                }
            }
        })

        // 监听耳机拔下事件
        var phoneListener = api.require('phoneListener');
        phoneListener.headphonePluggedListener({
                enable: true
            },
            function(ret) {
                if (!ret.state) {
                    api.sendEvent({
                        name: 'paused',
                    });
                }

            });
        api.setWinAttr({
            bounces: false
        });


        api.addEventListener({
            name: 'songid'
        }, function(ret, err) {
            if (ret.value.id != app.songid) {
                var sid = ret.value.id
                app.songid = ret.value.id
                app.index = ret.value.index
                    // console.log(JSON.stringify(ret.value.songlist));
                if (typeof(ret.value.songlist) == 'string') {
                    app.songdatalist = $api.strToJson(ret.value.songlist);

                } else {
                    app.songdatalist = ret.value.songlist
                }

                app.pause()
                app.init()
            }

        });

        api.addEventListener({
            name: 'replaying'
        }, function(ret, err) {
            $api.attr(playid, 'data-click', 0);
        });

        api.addEventListener({
            name: 'paused'
        }, function(ret, err) {
            app.pause()
        });
        api.addEventListener({
            name: 'replay'
        }, function(ret, err) {
            app.play()
        });

        api.addEventListener({
            name: 'playNext'
        }, function(ret, err) {
            if (ret) {
                app.playNext()
            } else {
                //  alert( JSON.stringify( err ) );
            }
        });
        api.addEventListener({
            name: 'playBack'
        }, function(ret, err) {
            if (ret) {
                app.playBack()
            } else {
                //  alert( JSON.stringify( err ) );
            }
        });
        // 断网了
        api.addEventListener({
            name: 'offline'
        }, function(ret, err) {
            api.toast({
                msg: '掉线了',
                duration: 2000,
                location: 'bottom'
            });

            app.pause()
        });

        // 已连接到网络
        api.addEventListener({
            name: 'online'
        }, function(ret, err) {
            api.toast({
                msg: '连上网络了',
                duration: 2000,
                location: 'bottom'
            });
            app.play()
        });

        H.openFrameGroupNavOrFoot(function(ret, err) {
            app.setStyle(ret.index);
            if(ret.index==1){
              api.setFrameGroupAttr({
                  name: 'groups',
                  scrollEnabled: false
              });
                api.lockSlidPane();

            }else{
              api.setFrameGroupAttr({
                  name: 'groups',
                  scrollEnabled: true
              });
              api.unlockSlidPane();
            }
        }, "groups", [{
            url: '../../html/page/page_frm.html',
            name: 'kuxuan'
        }, {
            url: '../../html/quan/jingxuan.html',
            name: 'quanzi'
        }], 0, "#header", "#footer",{bounces:false});

        var audioPlayer = api.require('audioPlayer');
        audioPlayer.addEventListener({
            name: "state"
        }, function(ret) {
            // console.log(JSON.stringify(ret));
            app.state = ret.state
            switch (ret.state) {
                case "playing":
                    app.isPlaying = true
                    app.music_img_min = imageCache(app.music_thumb + '?param=100y100')
                    break;
                case "paused":
                    app.isPlaying = false
                    api.sendEvent({
                        name: 'isNotPlaying',
                    });

                    break
                case "error":
                    app.stop()
                    api.sendEvent({
                        name: 'isNotPlaying',
                    });

                    api.toast({
                        msg: '出现错误，请稍后重试',
                        duration: 2000,
                        location: 'bottom'
                    });

                    break;
                case "finished":
                    api.sendEvent({
                        name: 'isNotPlaying',
                    });
                    app.playNext()
                    break;
                case "idle":
                    app.music_img_min = 'https://loading.io/spinners/microsoft/index.svg'
                    break;
                case "buffering":
                    app.music_img_min = 'https://loading.io/spinners/microsoft/index.svg'
                    break;
                default:
                    api.sendEvent({
                        name: 'isNotPlaying',
                    });

            }
        });
    });




    //  重写播放模块
    var app = new Vue({
        el: "#app",
        data: {
            songName: '新感官音乐世界',
            artists: '聆听音乐 感悟人生',
            songid: '',
            music_mp3: '',
            isPlaying: false,
            state: '',
            cur: '',
            per: '',
            current: '',
            music_imgurl: '',
            music_thumb: '',
            duration: '',
            songdatalist: '',
            isfirstopen: '',
            isclick: true,
            music_img_min: 'https://loading.io/spinners/microsoft/index.svg'
        },
        watch: {
            isPlaying(curVal, oldVal) {
                // console.log(curVal, oldVal);　　　　　　　　
            },
            music_imgurl(curVal, oldVal) {
                api.sendEvent({
                    name: 'upDateSongInfo',
                    extra: {
                        songName: app.songName,
                        artists: app.artists,
                        songid: app.songid,
                        music_imgurl: app.music_imgurl,
                        duration: app.duration,
                        music_mp3: app.music_mp3,
                        music_thumb: app.music_thumb,
                        music_img_min: app.music_img_min
                    }
                })　　　　　　　
            }
        },
        methods: {
            init: function() {
                app.isfirstopen = true
                music.isPlay(app.songid, function(ret, err) {

                    if (ret.success) {
                        app.music_mp3 = 'http://music.163.com/song/media/outer/url?id=' + app.songid + '.mp3'

                        music.getMusicInfo(app.songid, function(ret, err) {

                            if (ret.code == 200) {
                                music.play()
                                var songDetail = ret.songs[0]
                                app.songName = songDetail.name
                                app.music_thumb = songDetail.al ? songDetail.al.picUrl : songDetail.album.picUrl
                                app.music_img_min = imageCache(app.music_thumb + '?param=100y100')
                                app.artists = songDetail.ar ? songDetail.ar[0].name : songDetail.artists[0].name
                                api.imageCache({
                                    url: songDetail.al ? songDetail.al.picUrl : songDetail.album.picUrl + '?param=300y300'
                                }, function(ret, err) {
                                    app.music_imgurl = ret.url;
                                    app.audioCover()
                                });
                            } else {

                                api.alert({
                                    title: '错误提示',
                                    msg: "API故障请联系管理员",
                                }, function(ret, err) {
                                    if (ret) {
                                        // alert( JSON.stringify( ret ) );
                                    } else {
                                        // alert( JSON.stringify( err ) );
                                    }
                                });

                            }

                        })
                    } else {

                        if (err.statusCode == 400) {
                            api.alert({
                                title: '错误',
                                msg: err.msg,
                            }, function(ret, err) {

                            });

                        } else {
                            api.toast({
                                msg: ret.message,
                                duration: 2000,
                                location: 'bottom'
                            });
                            app.playNext()
                        }



                    }
                })
            },
            getMlistDB: function() { //首页获取播放历史列表
                api.openFrame({
                    name: 'page2',
                    url: 'history.html',
                    rect: {
                        x: 0,
                        y: api.winHeight - 300,
                        w: api.winWidth,
                        h: 300
                    },
                    bounces: false,
                    bgColor: 'rgba(0,0,0,0)',
                    vScrollBarEnabled: true,
                    hScrollBarEnabled: true,
                    animation: {
                        type: "push", //动画类型（详见动画类型常量）
                        subType: "from_bottom", //动画子类型（详见动画子类型常量）
                        duration: 400
                    }
                });
            },
            pause: function() {
                var audioPlayer = api.require('audioPlayer');
                audioPlayer.pause();
            },
            play: function() {
                var audioPlayer = api.require('audioPlayer');
                audioPlayer.play();
            },
            stop: function() {
                var audioPlayer = api.require('audioPlayer');
                audioPlayer.stop();
            },
            setPage: function(index, url) { //设置首页显示页面
                app.setStyle(index);
                if (H.isAPICloud()) {
                    H.setFrameGroupIndex("groups", index, true);
                } else {
                    H.D("#H-frame").setAttribute("src", url);
                }
            },
            setStyle: function(index) { // 设置切换TAB 样式效果
                var that = H.D("#tag div:nth-child(" + (index + 1) + ")");
                H.addClass(that, "H-theme-border-color-red H-theme-font-color-red");
                H.removeClass(H.siblings(that), "H-theme-border-color-red H-theme-font-color-red");
            },
            switchmusic: function() { // 底部控件——播放

                if (this.isPlaying) {
                    // 点开

                    this.pause()

                } else {
                    if (this.isfirstopen) {
                        this.play()
                    } else {
                        this.init()
                    }

                    //				}
                }
            },
            openS: function() {
                api.openWin({
                    name: 'search',
                    url: '../../html/search.html',
                    animation: {
                        type: "fade", //动画类型（详见动画类型常量）
                        subType: "from_right", //动画子类型（详见动画子类型常量）
                        duration: 600 //动画过渡时间，默认300毫秒
                    }
                });
            },
            playNext: function() {
                // console.log(app.index+1);
                if (this.isclick) {
                   app.isclick= false;
                    var isRepeat = $api.getStorage('isRepeat') && $api.getStorage('isRepeat') == 1 ? true : false
                    if (isRepeat) {
                        app.pause()
                        app.init()
                    } else {
                        if (app.index + 1 == app.songdatalist.length) {
                            app.songid = app.songdatalist[0].id
                            app.init()
                            app.index = 0
                        } else {
                            app.songid = app.songdatalist[app.index + 1].id
                            app.init()
                            app.index = app.index + 1

                        }
                    }
                    //定时器
                    setTimeout(function() {
                        app.isclick = true;
                    }, 500);
                }

            },
            playBack: function() {
                if (app.index == 0) {
                    app.songid = app.songdatalist[0].id
                    app.init()
                    app.index = 0
                } else {
                    app.songid = app.songdatalist[app.index - 1].id
                    app.init()
                    app.index = app.index - 1

                }
            },
            initmlist() { //初始化播放BAR,还没弄好
                var db = api.require('db');
                db.openDatabase({
                    name: 'history2'
                }, function(ret, err) {
                    if (ret.status) {
                        db.selectSql({
                            name: 'history2',
                            sql: 'SELECT * FROM mlist group by mlist_id order by mlist_date desc'
                        }, function(ret, err) {
                            if (ret.status) {
                                app.songName = ret.data[0].mlist_name
                                app.songid = ret.data[0].id
                                app.artists = ret.data[0].mlist_artist
                                app.music_img_min = ret.data[0].mlist_pic
                                app.index = 0
                                app.songdatalist = ret.data

                            } else {

                                // $api.html($api.byId('main'), '<span class="H-center-all">暂无数据</span>');
                                // alert(JSON.stringify(err));
                            }
                        });

                    } else {
                        alert(JSON.stringify(err));
                    }
                });
            },
            audioCover: function() {
                audioCover = api.require('audioCover');
                // console.log(app.per);
                var msg = {
                    totalTime: app.duration,
                    cover: app.music_imgurl,
                    progress: app.per,
                    audio: app.songName,
                    author: app.artists,
                }

                audioCover.set(msg, function(ret, err) {

                    if (ret.eventType == 'pause') {
                        //			pause();
                        app.play()

                    } else if (ret.eventType == 'next') {
                        app.stop();
                        app.playNext()
                    } else if (ret.eventType == 'previous') {
                        app.stop();
                        app.playBack()
                    } else if (ret.eventType == 'play') {
                        //			play()

                        app.pause()

                    } else {}
                });
            },

            openPlayer() {
                if (this.songName != '新感官音乐世界' && this.music_imgurl != '') {
                    api.openWin({
                        name: 'nww',
                        url: '../../html/music/bo_head.html',
                        delay: 100,
                        slidBackEnabled: false,
                        animation: {
                            type: "push", //动画类型（详见动画类型常量）
                            subType: "from_bottom", //动画子类型（详见动画子类型常量）
                            duration: 400 //动画过渡时间，默认300毫秒
                        },
                        pageParam: {
                            id: this.songid,
                            mp3: this.music_mp3,
                            songName: this.songName,
                            artists: this.artists,
                            music_imgurl: this.music_imgurl || this.music_img_min,
                            index: this.index,
                            duration: this.duration,
                            music_thumb: this.music_thumb

                        }
                    });
                }
            },
        }
    })
</script>


</html>
