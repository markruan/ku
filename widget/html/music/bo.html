<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
	<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
	<title>title</title>
	<link href="../../css/Hui.css" rel="stylesheet" type="text/css" />
	<link rel="stylesheet" type="text/css" href="http://at.alicdn.com/t/font_1466120150_564351.css">
	<style>
	.play-up-bg {
			margin: 0 auto;
			width: 70%;
			/*height: 60%;*/
			border-radius: 60%;
			border: 4px solid rgba(235, 103, 136, 0.48);
		}

		.xuanzhuan {
			-webkit-animation: circle 20s infinite linear;
			/*匀速 循环*/
		}

		@-webkit-keyframes circle {
			0% {
				transform: rotate(0deg);
			}
			100% {
				transform: rotate(-360deg);
			}
		}
	}
	.controler {
		height: 300px;
	}
	.controler-bg {
		width: 100%;
		/*position: absolute;*/
		/*图片模糊*/
		/*-webkit-filter: blur(30px);
				 max-height: 300px;*/
	}
	.e {
		left: 10px;
		text-align: right;
		/*padding-left: 100px;*/
	}
	.s {
		right: 100px;
		text-align: left;
		padding-right: 5px;
	}
	.icon-pause:before {
		content: "\e603";
		margin-top: 2px;
	}
	.<header class="aui-bar aui-bar-nav">顶部导航栏</header>-menu {
		background-color: rgba(151, 118, 118, 0);
	}
	#men {
		height: 300px;
	}
	.icon-focus {
		color: rgba(205, 198, 198, 0.2);
	}
	.kongZhi {
		margin-top: 12px;
		width: 80%;
		margin: 0 auto;
	}
	.H-width-80-percent {
		width: 80%;
	}
	.H-theme-font-color-white {
		color: #999;
	}
	.H-theme-font-color-white1 {
		color: white;
	}
	</style>
</head>
<script type="text/html" id="tppl">
	<span class="H-icon H-display-block H-horizontal-center"><i  id="shouC" onclick="shouCang(<%=list.id %>,null,'<%=list.mp3Url %>','<%=list.artists[0].name %>','<%=list.name %>','<%=list.album.picUrl %>')" tapmode=" iconfont  icon-focus " class="iconfont icon-xin   H-vertical-middle H-theme-font-color-white"style="    font-size:25px;"></i></span>
</script>
<script type="text/html" id="tppl2">
	<span class="H-icon H-display-block H-horizontal-center"><i onclick="openComm(<%=list.id %>, 1)" tapmode=" iconfont  icon-focus "  class="iconfont icon-pinglun   H-vertical-middle H-theme-font-color-white"style="    font-size:25px; "></i></span>
</script>

<body>
	<div class="" style="padding-top: 30px;">
		<img id="bg" data-img="" src="../../image/default.jpg" alt="" class="play-up-bg H-center-all ">
	</div>
	<div class="  " style="position: fixed;bottom: 0px;width: 100%;">

		<span id="title1" class="H-header-title H-center-all H-font-size-18 H-text-show-row-1 H-theme-font-color-white   H-width-100-percent" style="height:50px; "> </span>
		<!--<br />-->
		<span id="titleName" class="H-header-title H-center-all H-font-size-12 H-text-show-row-1 H-theme-font-color-white H-position-absolute H-width-100-percent" style="height:50px;"> </span>
		<br />
		<!--<span class="   H-theme-font-color-white  H-width-100-percent " > <i class="iconfont icon-play H-center-all H-margin-vertical-top-10 "style="font-size:60px;color: white;top: 12px;"> </i> </span>-->
		<div class="H-n-grid kongZhi H-clear-both  H-overflow-auto H-margin-vertical-top-12">
			<div class="H-clear-both H-width-100-percent H-display-table H-box-sizing-border-box H-center-all">
				<div class=" leftB  H-display-table-cell H-float-left H-box-sizing-border-box H-width-avg-3 H-center-all H-theme-background-color-transparent    H-padding-vertical-both-10" style="min-height: 80px;">
					<div>
						<span class="H-icon H-display-block H-horizontal-center"><i onclick="prev_b()" id="prev_b" data-sid="" data-index=""  tapmode  class="iconfont icon-mediaprevious  H-font-size-32 H-vertical-middle H-theme-font-color-white H-theme-font-color9-click"style="  font-size:30px;"></i></span>
					</div>
				</div>
				<div class="H-display-table-cell H-float-left H-box-sizing-border-box H-width-avg-3 H-center-all H-theme-background-color-transparent    H-padding-vertical-both-0" style="min-height: 80px;">
					<div>
						<span class=" H-icon H-display-block H-horizontal-center"><i   data-click="0" data-url="" onclick="switchmusic(this);" tapmode id="playerIcon" class="iconfont icon-zanting    H-vertical-middle H-theme-font-color-white H-theme-font-color9-click "style="  font-size:70px;"></i></span>
					</div>
				</div>
				<div class=" rightN H-display-table-cell H-float-left H-box-sizing-border-box H-width-avg-3 H-center-all H-theme-background-color-transparent   H-padding-vertical-both-10" style="min-height: 80px;">
					<div>
						<span id="next" class="H-icon H-display-block H-horizontal-center"><i onclick="playNext_b() "  id="playNext_b" data-sid="" data-index=""  tapmode  class="iconfont icon-medianext   H-font-size-32 H-vertical-middle H-theme-font-color-white H-theme-font-color9-click"style="  font-size:30px;"></i></span>
					</div>
				</div>
			</div>
		</div>
		<div id="slider" class="H-padding-horizontal-both-0  ">
			<span id="huakuai" class="s H-float-left   H-padding-horizontal-left-5 H-padding-vertical-top-10 H-z-index-1000" style="font-size: 1.1rem;  ">00:00</span>
			<!--<input id="hua" type="range"  oninput="change()"  class="H-range H-width-80-percent H-position-relative  H-border-radius-3 H-theme-font-white"  value="0" >-->
			<span class="e H-float-right   H-padding-horizontal-right-5 H-padding-vertical-top-10 H-z-index-1000" style="font-size: 1.1rem ; ">03:25</span>
		</div>
		<div id="palyB" class="H-n-grid  H-clear-both H-center-all H-overflow-auto">
			<div class=" H-clear-both H-width-100-percent H-display-table H-box-sizing-border-box H-padding-vertical-both-10">
				<div class="H-display-table-cell H-float-left H-box-sizing-border-box H-width-avg-5 H-center-all H-theme-background-color-transparent    H-padding-vertical-both-10" style=" min-height: 50px; ">
					<div>
						<span class="H-icon H-display-block H-horizontal-center"><i id="menubtn" onclick="openlist()" class="iconfont icon-mulu  H-font-size-60 H-vertical-middle H-theme-font-color-white" style="    font-size:25px;"></i></span>
					</div>
				</div>
				<div class="H-display-table-cell H-float-left H-box-sizing-border-box H-width-avg-5 H-center-all H-theme-background-color-transparent    H-padding-vertical-both-10" style="min-height: 50px;">
					<div class="result"></div>
				</div>
				<div class="H-display-table-cell H-float-left H-box-sizing-border-box H-width-avg-5 H-center-all H-theme-background-color-transparent     H-padding-vertical-both-10" style="min-height: 50px;">
					<div>
						<span class="H-icon H-display-block H-horizontal-center"><i id="rep" data-click="0" onclick="switchi(this);"  tapmode class="iconfont icon-xunhuan   H-vertical-middle H-theme-font-color-white"style="    font-size:25px;"></i></span>
					</div>
				</div>
				<div class="H-display-table-cell H-float-left H-box-sizing-border-box H-width-avg-5 H-center-all H-theme-background-color-transparent    H-padding-vertical-both-10" style="min-height: 50px;">
					<div>
						<span class="H-icon H-display-block H-horizontal-center"><i  onclick="shareWx()" tapmode  class="iconfont icon-share   H-vertical-middle H-theme-font-color-white"style="    font-size:25px;"></i></span>
					</div>
				</div>
				<div class="H-display-table-cell H-float-left H-box-sizing-border-box H-width-avg-5 H-center-all H-theme-background-color-transparent   H-padding-vertical-both-10" style="min-height: 50px;">
					<div class="result2"></div>
				</div>
			</div>
		</div>
	</div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/play.js"></script>
<script type="text/javascript" src="../../script/H.js"></script>
<script type="text/javascript">
	H.tppl_flag = ["<%", "%>"];
	var title2

	function pause() {
		var audioPlayer = api.require('audioPlayer');
		audioPlayer.pause();
	}

	function play() {
		var audioPlayer = api.require('audioPlayer');
		audioPlayer.play();
	}

	function stop() {
		var audioPlayer = api.require('audioPlayer');
		audioPlayer.stop();
	}
	// 分享
	function shareWx() {
		var thumb = $api.attr($api.byId('bg'), 'data-img');
		var title = $api.text($api.byId('title1'));
		var description = $api.text($api.byId('titleName'));
		var mp3url = $api.attr($api.byId('playerIcon'), 'data-url')
		var data = {}
		data.title = title;
		data.art = description;
		data.img = thumb;
		data.mp3 = mp3url;
		api.openFrame({
			name: 'sing_share',
			url: '../../html/single_share_body.html',
			bgColor: 'rgba(0,0,0,0.1)',
			rect: {
				x: 0,
				y: 0,
				w: api.winWidth,
				h: api.winHeight
			},
			animation: {
				type: "fade", //动画类型（详见动画类型常量）
				subType: "from_right", //动画子类型（详见动画子类型常量）
				duration: 300 //动画过渡时间，默认300毫秒

			},
			pageParam: {
				data: data
			},
		});
	}

	// 播放样式
	function switchmusic(button) {
		var bg = $api.byId('bg');
		var click = button.getAttribute("data-click");
		var audioPlayer = api.require('audioPlayer');
		if (click == 0) {
			// 点开
			$api.removeCls(bg, 'xuanzhuan');
			button.setAttribute("data-click", 1);
			audioPlayer.pause();
			api.sendEvent({
				name: 'stopmusic'
			});
			$api.attr(button, 'class', 'iconfont  icon-bofang H-theme-font-color-white animated bounceIn');
		} else {
			// 关闭
			$api.addCls(bg, 'xuanzhuan');
			button.setAttribute("data-click", 0);
			$api.attr(button, 'class', 'iconfont  icon-zanting H-theme-font-color-white animated bounceIn');

			audioPlayer.play();
			api.sendEvent({
				name: 'playing'
			});
		}
	}

	// 下一曲
	function playNext_b() {
		var sid = $api.attr($api.byId('playNext_b'), 'data-sid');
		var index_m = $api.attr($api.byId('playNext_b'), 'data-index');
		var audioPlayer = api.require('audioPlayer');
		audioPlayer.stop();
		uiloading()
		api.sendEvent({
			name: 'playNext',
			extra: {
				sid: sid,
				index: index_m
			}
		});
	}

	// 上一曲
	function prev_b() {
		var sid = $api.attr($api.byId('prev_b'), 'data-sid');
		var index_m = $api.attr($api.byId('prev_b'), 'data-index');
		var audioPlayer = api.require('audioPlayer');
		uiloading()
		audioPlayer.stop();
		api.sendEvent({
			name: 'prev_b',
			extra: {
				sid: sid,
				index: index_m
			}
		});
	}

	// 设置播放模式
	function switchi(button) {
		var rep = $api.byId('rep');
		var click = button.getAttribute("data-click");
		if (click == 0) {
			// 点开
			button.setAttribute("data-click", 1);
			$api.removeCls(rep, 'icon-xunhuan');
			$api.addCls(rep, 'icon-danquxunhuan');
			$api.setStorage('PlayAll', 1);
		} else {
			// 关闭
			button.setAttribute("data-click", 0);
			$api.removeCls(rep, 'icon-danquxunhuan');
			$api.addCls(rep, 'icon-xunhuan');
			$api.setStorage('PlayAll', 0);

		}
	}

	// 获取歌曲信息
	function getinfo(sid) {
		var songid, mp3Url, cover
		api.ajax({
			url: 'http://music.163.com/api/song/detail/?id=' + sid + '&ids=[' + sid + ']',
		}, function(ret, err) {
			var songdata = ret.songs[0]
			var data = {
				list: songdata
			};
			var render = H.tppl(H.D("#tppl").innerHTML);
			H.D(".result").innerHTML = render(data);
			var render = H.tppl(H.D("#tppl2").innerHTML);
			H.D(".result2").innerHTML = render(data);
			var artist = songdata.artists[0].name
			var datetime = Number(new Date())
			saveMlistDB(sid, songdata.name, artist, songdata.album.picUrl, datetime) //存储播放历史
			api.imageCache({
				url: songdata.album.picUrl
			}, function(ret, err) {
				cover = ret.url
				var title2 = songdata.name
				$api.attr($api.byId('bg'), 'data-img', cover);
				$api.attr($api.byId('bg'), 'src', cover + '?param=250y250');
				$api.text($api.byId('title1'), title2);
				$api.text($api.byId('titleName'), songdata.artists[0].name);
			});
			api.ajax({
				url: songDetail + songdata.id
			}, function(ret, err) {
				if (ret&&ret.data[0].url != null) {
					var mp3Url = ret.data[0].url.replace(/https/, 'http')
						// 去除安全限制
			   $api.attr($api.byId('playerIcon'), 'data-url', mp3Url);
					play_c(mp3Url, cover, songdata.name, songdata.artists[0].name)
				} else {
					playNext_b()
					api.toast({
						msg: '版权问题，自动播放下一曲'
					});
				}
			});
		});
	}

	function intt(sid, index_m) {
		var bg = $api.byId('bg');
		var bgw = $api.offset(bg).w / 2;
		getinfo(sid)
		$api.attr($api.byId('playerIcon'), 'class', 'iconfont  icon-zanting H-theme-font-color-white');
		$api.attr($api.byId('playerIcon'), 'data-click', 0);
		$api.attr($api.byId('playNext_b'), 'data-sid', sid);
		$api.attr($api.byId('playNext_b'), 'data-index', index_m);
		$api.attr($api.byId('prev_b'), 'data-sid', sid);
		$api.attr($api.byId('prev_b'), 'data-index', index_m);
	}

	apiready = function() {
			var sid, index_m
			var cover
			var sid = api.pageParam.sid
			var index_m = api.pageParam.index
			var audioPlayer = api.require('audioPlayer');
			var menubtn = $api.byId("menubtn")
			var juli = $api.offset(menubtn).l
			$api.attr($api.byId('slider'), 'style', 'width' + juli);
			// 监听是否播放
			audioPlayer.addEventListener({
				name: "state"
			}, function(ret) {
				if (ret.state == "playing") {
					$api.addCls(bg, 'xuanzhuan');
				} else {
					$api.removeCls(bg, 'xuanzhuan');

				}
			});

			uiloading();
			intt(sid, index_m)
			api.addEventListener({
				name: 'nextsong'
			}, function(ret, err) {
				playNext_b()
			});
			api.addEventListener({
				name: 'replaying'
			}, function(ret, err) {
				$api.addCls(bg, 'xuanzhuan');
				play()
			});
			api.addEventListener({
				name: 'startplaying'
			}, function(ret, err) {
				$api.addCls(bg, 'xuanzhuan');
			});
			api.addEventListener({
				name: 'songid'
			}, function(ret, err) {
				if (ret) {
					sid = ret.value.sid
					index_m = ret.value.index
					intt(sid, index_m)
				}
			});
			api.addEventListener({
				name: 'stopmusic'
			}, function(ret, err) {
				pause();
				$api.removeCls(bg, 'xuanzhuan');
			});
			api.parseTapmode();
			$api.setStorage('PlayAll', 'a')
			api.addEventListener({
				name: 'firstsong'
			}, function(ret, err) {
				if (ret) {
					api.toast({
						msg: '第一首了，亲'
					});
					api.hideProgress();
				}
			});
			api.addEventListener({
				name: 'lastsong'
			}, function(ret, err) {
				if (ret) {
					api.toast({
						msg: '最后一首了，亲'
					});
					api.hideProgress();
				}
			});
			var offset = $api.offset(H.D(".s"));
			var width = offset.w;
			var top = offset.t
			test(width, top)
			$api.setStorage('isopen', 1);

			// 上下曲
    	api.addEventListener({
				name: 'playNext'
			}, function(ret, err) {
				var index_m = Number(ret.value.index) + 1
				var arr = $api.getStorage('listm');
				if (arr) {
					if (index_m == arr.length) {
						var sid = arr[0].id
						api.sendEvent({
							name: 'songid',
							extra: {
								sid: sid,
								index: 0
							}
						});
						return
					}
					var sid = arr[index_m].id
					audioPlayer.stop();
					api.sendEvent({
						name: 'songid',
						extra: {
							sid: sid,
							index: index_m
						}
					});
				} else {
         api.toast({
             msg: '暂无数据',
             duration: 2000,
             location: 'bottom'
         });


				}
			});
			api.addEventListener({
				name: 'prev_b'
			}, function(ret, err) {
				var arr = $api.getStorage('listm');
				var index_m = Number(ret.value.index) - 1
				if (index_m < 0) {
					api.sendEvent({
						name: 'firstsong'
					});
					return
				}
				var sid = arr[index_m].id

				audioPlayer.stop();
				api.sendEvent({
					name: 'songid',
					extra: {
						sid: sid,
						index: index_m
					}
				});
			});
		}
		// 进度条
	function test(width, top) {
		var uislider = api.require('UISlider');
		uislider.open({
			animation: true,
			orientation: 'horizontal',
			rect: {
				x: width,
				y: top + 16,
				size: api.winWidth - width * 2
			},
			bubble: {
				direction: 'top',
				state: 'hide'
			},
			handler: {
				w: 6,
				h: 6,
				bg: 'widget://image/slider/slider-btn.png'
			},
			bar: {
				h: 3,
				bg: 'widget://image/slider/slider-bg.png',
				active: 'widget://image/slider/slider-btn2.png'
			},
			value: {
				min: 0, //数字类型；滑动控件的最小值
				max: 100, //数字类型；滑动控件的最大值
				step: 1, //数字类型；滑动时的步幅
				init: 0,
			},
			fixedOn: api.frameName,
			fixed: false
		}, function(ret, err) {
			//			alert(JSON.stringify(ret));
			if (ret.eventType == 'end') {
				var audioPlayer = api.require('audioPlayer');
				var duration = $api.getStorage('duration');
				audioPlayer.setCurrent({
					current: ret.value / 100 * duration
				});
				//					alert(JSON.stringify(ret));
			} else {
				//					alert(JSON.stringify(err));
			}
		});
	}

	function openlist() {
		api.openFrame({
			name: 'mlist_bo',
			url: 'bolist.html',

			rect: {
				x: 0,
				y: api.winHeight - 300,
				w: api.winWidth,
				h: 300
			},
    	bounces: false,
			bgColor: 'rgba(0,0,0,0)',
			vScrollBarEnabled: true,
			hScrollBarEnabled: true
		});


	}
</script>
</body>

</html>
