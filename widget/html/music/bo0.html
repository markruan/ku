<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
	<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
	<title>title</title>
	<link href="../../css/Hui.css" rel="stylesheet" type="text/css" />
	<link rel="stylesheet" type="text/css" href="http://at.alicdn.com/t/font_1466120150_564351.css">
	<script type="text/javascript" src="../../script/vue.min.js"></script>

	<style>
	.play-up-bg {
			margin: 0 auto;
			width: 70%;
			/*height: 60%;*/
			border-radius: 60%;
			border: 4px solid rgba(235, 103, 136, 0.48);
		}

		.xuanzhuan {
			-webkit-animation: circle 20s infinite linear;
			/*匀速 循环*/
		}

		@-webkit-keyframes circle {
			0% {
				transform: rotate(0deg);
			}
			100% {
				transform: rotate(360deg);
			}
		}
	}
	.controler {
		height: 300px;
	}
	.controler-bg {
		width: 100%;
		/*position: absolute;*/
		/*图片模糊*/
		/*-webkit-filter: blur(30px);
				max-height: 300px;*/
	}
	.e {
		left: 10px;
		text-align: right;
		/*padding-left: 100px;*/
	}
	.s {
		right: 100px;
		text-align: left;
		padding-right: 5px;
	}
	.icon-pause:before {
		content: "\e603";
		margin-top: 2px;
	}
	#men {
		height: 300px;
	}
	.icon-focus {
		color: rgba(205, 198, 198, 0.2);
	}
	.kongZhi {
		margin-top: 12px;
		width: 80%;
		margin: 0 auto;
	}
	.H-width-80-percent {
		width: 80%;
	}
	.H-theme-font-color-white {
		color: #999;
	}
	.H-theme-font-color-white1 {
		color: white;
	}
	</style>
</head>

<body>
	<div id="app">
		<div class="" style="padding-top: 30px;">
			<!-- <img id="bg" :src='music_imgurl' alt=""  v-blind:class="play-up-bg H-center-all "> -->
			<img id="bg" :src='music_imgurl' alt="" :class="{ xuanzhuan:playState }" class="play-up-bg H-center-all ">

		</div>
		<div class="  " style="position: fixed;bottom: 0px;width: 100%;">
			<span class="H-header-title H-center-all H-font-size-18 H-text-show-row-1 H-theme-font-color-white   H-width-100-percent" style="height:30px; ">{{music_title}} </span>
			<!--<br />-->
			<span id="titleName" class="H-header-title H-center-all H-font-size-12 H-text-show-row-1 H-theme-font-color-white H-position-absolute H-width-100-percent" style="height:50px;">{{music_artist}} </span>
			<br />
			<!--<span class="   H-theme-font-color-white  H-width-100-percent " > <i class="iconfont icon-play H-center-all H-margin-vertical-top-10 "style="font-size:60px;color: white;top: 12px;"> </i> </span>-->
			<div class="H-n-grid kongZhi H-clear-both  H-overflow-auto H-margin-vertical-top-12">
				<div class="H-clear-both H-width-100-percent H-display-table H-box-sizing-border-box H-center-all">
					<div class=" leftB  H-display-table-cell H-float-left H-box-sizing-border-box H-width-avg-3 H-center-all H-theme-background-color-transparent    H-padding-vertical-both-10" style="min-height: 80px;">
						<div>
							<span class="H-icon H-display-block H-horizontal-center"><i tapmode @click="playBack" id="prev_b" data-sid="" data-index=""  tapmode  class="iconfont icon-mediaprevious  H-font-size-32 H-vertical-middle H-theme-font-color-white H-theme-font-color9-click"style="  font-size:30px;"></i></span>
						</div>
					</div>
					<div class="H-display-table-cell H-float-left H-box-sizing-border-box H-width-avg-3 H-center-all H-theme-background-color-transparent    H-padding-vertical-both-0" style="min-height: 80px;">
						<div>
							<span class=" H-icon H-display-block H-horizontal-center"><i   data-click="0" tapmode data-url=""   @click='switchmusic' tapmode :class='[isPlaying?pauseicon:playicon]' class="iconfont   H-vertical-middle H-theme-font-color-white H-theme-font-color9-click "style="  font-size:70px;"></i></span>
						</div>
					</div>
					<div class=" rightN H-display-table-cell H-float-left H-box-sizing-border-box H-width-avg-3 H-center-all H-theme-background-color-transparent   H-padding-vertical-both-10" style="min-height: 80px;">
						<div>
							<span id="next" class="H-icon H-display-block H-horizontal-center"><i tapmode @click="playNext" id="playNext_b" data-sid="" data-index=""  tapmode  class="iconfont icon-medianext   H-font-size-32 H-vertical-middle H-theme-font-color-white H-theme-font-color9-click"style="  font-size:30px;"></i></span>
						</div>
					</div>
				</div>
			</div>
			<div id="slider" class="H-padding-horizontal-both-0  ">
				<span id="huakuai" class="s H-float-left   H-padding-horizontal-left-5 H-padding-vertical-top-10 H-z-index-1000" style="font-size: 1.1rem;  ">00:00</span>
				<!--<input id="hua" type="range"  oninput="change()"  class="H-range H-width-80-percent H-position-relative  H-border-radius-3 H-theme-font-white"  value="0" >-->
				<span class="e H-float-right   H-padding-horizontal-right-5 H-padding-vertical-top-10 H-z-index-1000" style="font-size: 1.1rem ; ">03:25</span>
			</div>
			<div id="palyB" class="H-n-grid  H-clear-both H-center-all H-overflow-auto">
				<div class=" H-clear-both H-width-100-percent H-display-table H-box-sizing-border-box H-padding-vertical-both-10">
					<div class="H-display-table-cell H-float-left H-box-sizing-border-box H-width-avg-5 H-center-all H-theme-background-color-transparent    H-padding-vertical-both-10" style=" min-height: 50px; ">
						<div>
							<span class="H-icon H-display-block H-horizontal-center"><i id="menubtn" tapmode @click="openlist" class="iconfont icon-mulu  H-font-size-60 H-vertical-middle H-theme-font-color-white" style="    font-size:25px;"></i></span>
						</div>
					</div>
					<div class="H-display-table-cell H-float-left H-box-sizing-border-box H-width-avg-5 H-center-all H-theme-background-color-transparent    H-padding-vertical-both-10" style="min-height: 50px;">
						<div>
							<span class="H-icon H-display-block H-horizontal-center"><i  id="shouC" tapmode @click='setcomm' tapmode=" iconfont  icon-focus " class="iconfont icon-xin   H-vertical-middle H-theme-font-color-white"style="    font-size:25px;"></i></span>

						</div>
					</div>
					<div class="H-display-table-cell H-float-left H-box-sizing-border-box H-width-avg-5 H-center-all H-theme-background-color-transparent     H-padding-vertical-both-10" style="min-height: 50px;">
						<div>
							<span class="H-icon H-display-block H-horizontal-center"><i id="rep" data-click="0" tapmode  @click='isXunHuan' tapmode  :class="[isRepeat?xunHuanIcon:noXunHuanIcon]" class="iconfont    H-vertical-middle H-theme-font-color-white"style="    font-size:25px;"></i></span>
						</div>
					</div>
					<div class="H-display-table-cell H-float-left H-box-sizing-border-box H-width-avg-5 H-center-all H-theme-background-color-transparent    H-padding-vertical-both-10" style="min-height: 50px;">
						<div>
							<span class="H-icon H-display-block H-horizontal-center"><i tapmode @click="shareWx" tapmode  class="iconfont icon-share   H-vertical-middle H-theme-font-color-white"style="    font-size:25px;"></i></span>
						</div>
					</div>
					<div class="H-display-table-cell H-float-left H-box-sizing-border-box H-width-avg-5 H-center-all H-theme-background-color-transparent   H-padding-vertical-both-10" style="min-height: 50px;">
						<div>
							<span class="H-icon H-display-block H-horizontal-center"><i tapmode @click="openComm" tapmode=" iconfont  icon-focus "  class="iconfont icon-pinglun   H-vertical-middle H-theme-font-color-white"style="    font-size:25px; "></i></span>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/play.js"></script>
<script type="text/javascript">
	apiready = function() {
		app.music_id = api.pageParam.sid
		app.music_index = api.pageParam.index
		app.slider()
		$api.setStorage('isopen', 1);

		app.init()
		api.addEventListener({
			name: 'songid'
		}, function(ret, err) {
			if (ret) {
				app.music_id = ret.value.sid
				app.music_index = ret.value.index
				app.init()
			} else {
				alert(JSON.stringify(err));
			}
		});
		api.addEventListener({
			name: 'playNext'
		}, function(ret, err) {
			if (ret) {
				app.playNext()
			} else {
				//  alert( JSON.stringify( err ) );
			}
		});
		api.addEventListener({
			name: 'pause'
		}, function(ret, err) {
			if (ret) {
				app.isPlaying = false
				app.pause()
			} else {
				//  alert( JSON.stringify( err ) );
			}
		});
		api.addEventListener({
			name: 'replaying'
		}, function(ret, err) {
			if (ret) {
				app.isPlaying = true
				app.replay()
			} else {
				//  alert( JSON.stringify( err ) );
			}
		});



	}

	var app = new Vue({
		el: '#app',
		data: {
			music_imgurl: '../../image/default.jpg',
			music_title: '',
			music_artist: '',
			music_id: '',
			music_mp3: '',
			music_index: '',
			playState: true,
			isPlaying: true,
			isRepeat: false,
			xunHuanIcon: 'icon-danquxunhuan',
			noXunHuanIcon: 'icon-xunhuan',
			playicon: 'icon-bofang',
			pauseicon: 'icon-zanting'
		},
		methods: {
			init: function() {
				uiloading();
				api.ajax({
					url: musicApi + '/song/detail?ids=' + app.music_id,
				}, function(ret, err) {
					//  console.log($api.jsonToStr(ret));
					if (ret.code == 200) {
						app.music_title = ret.songs[0].name
						app.music_artist = ret.songs[0].ar[0].name
							// app.music_imgurl = ret.songs[0].al.picUrl + '?param=500y500'
							// app.music_imgurl = imageCache(ret.songs[0].al.picUrl)
						api.imageCache({
							url: ret.songs[0].al.picUrl + '?param=500y500'
						}, function(ret, err) {
							if (ret) {
								app.music_imgurl = ret.url
							} else {
								//  alert( JSON.stringify( err ) );
							}
						});


						app.getMusic(ret.songs[0].id)
					} else {
						// alert( JSON.stringify( err ) );
						api.toast({
							msg: '网络错误',
							duration: 2000,
							location: 'bottom'
						});

					}
				});
			},
			getMusic: function(music_id) {
				api.ajax({
					url: songDetail + music_id
				}, function(ret, err) {
					if (ret && ret.data[0].url != null) {
						var mp3Url = ret.data[0].url.replace(/https/, 'http')
							// 去除安全限制
						$api.attr($api.byId('playerIcon'), 'data-url', mp3Url);
						app.music_mp3 = mp3Url
						play_c(mp3Url, app.music_imgurl, app.music_title, app.music_artist)
					} else {
						playNext_b()
						api.toast({
							msg: '版权问题，自动播放下一曲'
						});
					}
				})
			},
			switchmusic: function() {
				if (app.isPlaying) {
					app.isPlaying = false;
					app.pause()
				} else {
					app.isPlaying = true;
					app.replay()
				}
			},
			pause: function() {
				var audioPlayer = api.require('audioPlayer');
				audioPlayer.pause();
			},
			replay: function() {
				var audioPlayer = api.require('audioPlayer');
				audioPlayer.play();
			},
			stop: function() {
				var audioPlayer = api.require('audioPlayer');
				audioPlayer.stop();
			},
			slider: function() {
				var offset = $api.offset($api.byId('huakuai'));
				var width = offset.w;
				var top = offset.t
				var uislider = api.require('UISlider');
				uislider.open({
					animation: true,
					orientation: 'horizontal',
					rect: {
						x: width,
						y: top + 16,
						size: api.winWidth - width * 2
					},
					bubble: {
						direction: 'top',
						state: 'hide'
					},
					handler: {
						w: 10,
						h: 10,
						bg: 'widget://image/slider/slider-btn.png'
					},
					bar: {
						h: 3,
						bg: 'widget://image/slider/slider-bg.png',
						active: 'widget://image/slider/slider-btn2.png'
					},
					value: {
						min: 0, //数字类型；滑动控件的最小值
						max: 100, //数字类型；滑动控件的最大值
						step: 1, //数字类型；滑动时的步幅
						init: 0,
					},
					fixedOn: api.frameName,
					fixed: false
				}, function(ret, err) {
					//			alert(JSON.stringify(ret));
					if (ret.eventType == 'end') {
						var audioPlayer = api.require('audioPlayer');
						var duration = $api.getStorage('duration');
						audioPlayer.setCurrent({
							current: ret.value / 100 * duration
						});
						//					alert(JSON.stringify(ret));
					} else {
						//					alert(JSON.stringify(err));
					}
				});
			},
			openlist: function() {
				api.openFrame({
					name: 'mlist_bo',
					url: 'bolist.html',

					rect: {
						x: 0,
						y: api.winHeight - 300,
						w: api.winWidth,
						h: 300
					},
					bounces: false,
					bgColor: 'rgba(0,0,0,0)',
					vScrollBarEnabled: true,
					hScrollBarEnabled: true
				});
			},
			shareWx: function() {
				var data = {}
				data.title = app.music_title;
				data.art = app.music_artist;
				data.img = app.music_imgurl;
				data.mp3 = app.music_mp3
				api.openFrame({
					name: 'sing_share',
					url: '../../html/single_share_body.html',
					bgColor: 'rgba(0,0,0,0.1)',
					rect: {
						x: 0,
						y: 0,
						w: api.winWidth,
						h: api.winHeight
					},
					animation: {
						type: "fade", //动画类型（详见动画类型常量）
						subType: "from_right", //动画子类型（详见动画子类型常量）
						duration: 300 //动画过渡时间，默认300毫秒

					},
					pageParam: {
						data: data
					},
				});

			},
			openComm: function() {
				if (!$api.getStorage('userinfo')) {
					api.toast({
						msg: '请先登陆'
					});
					return
				}
				api.openWin({
					name: 'comm',
					url: '../../html/music/comm/head.html',
					opaque: true,
					vScrollBarEnabled: false,
					pageParam: {
						type: 1,
						sid: app.music_id
					}
				});

			},
			isXunHuan: function() {
				if (app.isRepeat) {
					app.isRepeat = false
				} else {
					app.isRepeat = true
				}
			},
			playNext: function() {
				app.stop()
				var arr = $api.getStorage('listm');
				var index_m = Number(app.music_index) + 1
				if (index_m == arr.length) {
					api.sendEvent({
						name: 'songid',
						extra: {
							sid: arr[0].id,
							index: 0
						}
					});

				} else {
					api.sendEvent({
						name: 'songid',
						extra: {
							sid: arr[index_m].id,
							index: index_m
						}
					});

				}
			},
			playBack: function() {
				app.stop()
				var arr = $api.getStorage('listm');
				var index_m = Number(app.music_index) - 1
				if (index_m <= 0) {
					api.sendEvent({
						name: 'songid',
						extra: {
							sid: arr[0].id,
							index: 0
						}
					});
					api.toast({
						msg: '第一首了',
						duration: 2000,
						location: 'bottom'
					});
				} else {
					api.sendEvent({
						name: 'songid',
						extra: {
							sid: arr[index_m].id,
							index: index_m
						}
					});
				}
			},
			setcomm: function() {
				if (!$api.getStorage('userinfo')) {
					api.toast({
						msg: '先登陆'
					});
					return
				}
				api.ajax({
					url: hostUrl + '/mylist.php',
					method: 'post',
				  data: {
						values: {
							sid: app.music_id,
							uid: $api.getStorage('userinfo').data_id
						}
					}
				}, function(ret, err) {
					if (ret.code==200) {
						api.ajax({
							url: hostUrl + '/addm.php',
							method: 'post',
							cache: true,
							timeout: 30,
							dataType: 'json',
							data: {
								values: {
									artist: app.music_artist,
									title: app.music_title,
									uid: $api.getStorage('userinfo').data_id,
									background: app.music_imgurl,
									cover: app.music_imgurl,
									sid: app.music_id
								}
							}
						}, function(ret, err) {
							//coding...
						});
						api.toast({
							msg: '收藏成功'
						});
					} else if (ret.code == 202) {
						api.confirm({
							title: '取消收藏',
							msg: '亲，要取消吗？',
							buttons: ['确定', '取消']
						}, function(ret, err) {
							if (ret.buttonIndex == 1) {
								app.quXiaoShouCang()
							}
						});
					} else {
						api.toast({
							msg: '收藏失败'
						});
					}
					//coding...
				});
			},
			quXiaoShouCang:function(){
				var uid = $api.getStorage('userinfo').data_id
				api.ajax({
						url: hostUrl + '/quxiao.php?uid=' + uid + '&sid=' + app.music_id,
         }, function(ret, err) {
						api.toast({
								msg: ret.msg
						});
				});
			}

		}
	})
</script>

</html>
