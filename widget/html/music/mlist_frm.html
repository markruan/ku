<!doctype html>
<html>

<head>
	<meta charset="UTF-8">
	<meta name="copyright" content="www.apicloud.com" />
	<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
	<title>歌单</title>
	<link rel="stylesheet" type="text/css" href="../../css/api.css" />
	<style>
		html,
		body {
			min-height: 100%;
			background-color: #f9f9f9;
		}

		.fr {
			float: right;
		}

		.fl {
			float: left;
		}

		.mt5 {
			margin-top: 5px;
		}

		.mt10 {
			margin-top: 10px;
		}

		.mt15 {
			margin-top: 15px;
		}

		.mt20 {
			margin-top: 20px;
		}

		.ml5 {
			margin-left: 0.5em;
		}

		.mr5 {
			margin-right: 0.5em;
		}

		.hdivider {
			width: 100%;
			height: 1px;
			background-color: #e0e0e0;
		}

		.br {
			border-right: 1px solid #e0e0e0;
		}

		.row {
			display: -webkit-box;
			display: -webkit-flex;
		}

		.col {
			-webkit-box-flex: 1;
			-webkit-flex: 1;
			flex: 1;
			margin: 0 5px;
			position: relative;
		}

		.swiper-container img {
			width: 100%;
		}
		/* 歌单标题 */

		.sectionTitle {
			height: 2em;
			line-height: 2em;
			font-size: 1.12em;
		}

		.sectionTitle .titleDivider {
			display: inline-block;
			height: 1.12em;
			width: 3px;
			vertical-align: top;
			background-color: #D43C33;
			margin-top: 0.44em;
			margin-left: 0.7em;
			margin-right: 0.3em;
		}
		/* 歌单 */

		.col .listcoverbar {
			position: absolute;
			top: 0;
			background-color: rgba(0, 0, 0, 0.4);
			width: 100%;
			height: 1.2em;
		}

		.col .listcoverbar span {
			color: #fff;
		}

		.col .listcoverbar .earphone {
			width: 1em;
			margin-top: 0.2em;
			margin-right: 0.3em;
		}

		.col .listcover {
			width: 100%;
		}

		.col .listtitle {
			height: 2.4em;
			font-size: 1em;
			line-height: 1.2em;
			overflow: hidden;
			text-overflow: ellipsis;
			display: -webkit-box;
			-webkit-line-clamp: 2;
			-webkit-box-orient: vertical;
		}
		/* item样式 */

		.egret-item {
			height: 4em;
		}

		.egret-item .egret-item-box-cover-center {
			display: table;
			height: inherit;
		}

		.egret-item .egret-item-box-cover-center .egret-item-box-abtc {
			display: table-cell;
			vertical-align: middle;
		}

		.egret-item .egret-item-box-cover-center .egret-item-box-abtc img {
			width: 3em;
			vertical-align: top;
		}
		/* 右侧箭头样式 */

		.egret-item .egret-item-arrow {
			display: table;
			height: inherit;
		}

		.egret-item .egret-item-arrow .egret-item-box-abtc {
			display: table-cell;
			vertical-align: middle;
		}

		.egret-item .egret-item-arrow .egret-item-box-abtc img {
			width: 0.8em;
			vertical-align: top;
		}
		/* 中间shelf  两个条目*/

		.egret-item .egret-item-shelf {
			height: inherit;
		}

		.egret-item .egret-item-shelf .egret-item-shelf-title {
			font-size: 1.1em;
			margin-top: 0.6em;
		}

		.egret-item .egret-item-shelf .egret-item-shelf-subtitle {
			font-size: 0.6em;
			color: #666;
			margin-top: 0.6em;
		}
		/* 中间shelf 一个条目 */

		.egret-item .egret-item-shelf-single {
			height: inherit;
			line-height: 4em;
			font-size: 1.1em;
		}

		.egret-item .egret-item-shelf-redclassify {
			color: #E03F40;
			border: 1px solid #E03F40;
			font-size: inherit;
			padding: 0.1em;
			border-radius: 1px;
			margin-right: 5px;
		}
		/* 用flex重写框架 */

		.egret-flex-item {
			display: -webkit-box;
			-webkit-box-align: center;
			height: 3em;
			/*background-color: #fff;*/
		}
		/* 左部logo */

		.egret-flex-item-logo {
			max-width: 50px;
			min-width: 50px;
			margin-left: 0.5em;
			margin-right: 0.2em;
			-webkit-box-flex: 1;
			-webkit-box-align: center;
		}

		.egret-flex-item-logo img {
			height: 2em;
			width: 2em;
			-webkit-box-align: center;
			vertical-align: top;
			/*否则图片不会居中，底部仍然是会有空白*/
		}
		/* 中间文本信息 */

		.egret-flex-item-shelf {
			overflow: hidden;
			-webkit-box-flex: 2;
			-webkit-box-align: center;
		}

		.egret-flex-item-shelf div {
			text-overflow: ellipsis;
			white-space: nowrap;
			overflow: hidden;
		}

		.egret-flex-item-shelf .egret-flex-item-shelf01 {
			font-size: 1.1em;
		}

		.egret-flex-item-shelf .egret-flex-item-shelf02 {
			font-size: 0.6em;
			color: #666;
			margin-top: 0.6em;
		}

		.egret-flex-item-shelf .egret-flex-item-redclassify {
			color: #E03F40;
			border: 1px solid #E03F40;
			font-size: inherit;
			padding: 0.1em;
			border-radius: 1px;
			margin-right: 5px;
		}
		/* 右部箭头 */

		.egret-flex-item-arrow {
			-webkit-box-flex: 1;
			max-width: 10px;
			min-width: 10px;
			margin-right: 15px;
		}

		.egret-flex-item-arrow img {
			width: 100%;
			max-width: 10px;
		}
		/* 暗头部 */

		.egret-dark-title {
			height: 1.4em;
			line-height: 1.4em;
			font-size: 0.8em;
			background-color: #e7e7e7;
			color: #666;
			padding-left: 10px;
		}
		/* special 对个别自定义 */

		.special {
			height: 4em;
		}

		.special .egret-flex-item-logo img {
			height: 3em;
			width: 3em;
		}
		/* */

		.inputmusic {
			text-align: center;
			margin-top: 30px;
		}

		.inputmusic p {
			color: #6F6F6F;
		}

		.inputmusic p .inputbtn {
			color: #3A9DD3;
			text-decoration: underline;
		}
		/* 独立条目 */

		.isolateitem-top {
			margin-top: 10px;
			border-top: 1px solid #e0e0e0;
		}

		.isolateitem-bottom {
			border-bottom: 1px solid #e0e0e0;
		}
		/* 退出 */

		.exitbtn {
			margin: 15px 10px;
			border-radius: 4px;
			border: 1px solid #D33A31;
			background-color: #fff;
			color: #D33A31;
			text-align: center;
			height: 2em;
			line-height: 2em;
		}
		/* 个人用户标题 */

		.musiclistprofile {
			height: 7em;
			background-color: #fff;
		}

		.musiclistprofile .egret-flex-item-logo img {
			height: 6em;
			width: 6em;
		}

		.musiclistprofile .egret-flex-item-logo {
			max-width: 6em;
			min-width: 6em;
			margin-left: 0.5em;
			margin-right: 0.2em;
			-webkit-box-flex: 1;
			-webkit-box-align: center;
		}

		.musiclistprofile .egret-flex-item-shelf {
			margin-left: 0.5em;
		}

		.musiclistprofile .egret-flex-item-shelf .egret-flex-item-shelf01 {
			font-size: 1.3em;
		}

		.musiclistprofile .egret-flex-item-shelf .egret-flex-item-shelf02 {
			margin-top: 1.6em;
			-webkit-box-align: center;
			display: -webkit-box;
		}

		.musiclistprofile .egret-flex-item-shelf .egret-flex-item-shelf02 .createrlogo {
			width: 2em;
		}

		.musiclistprofile .egret-flex-item-shelf .egret-flex-item-shelf02 .creatername {
			margin: 0 1em;
		}

		.userinfo {
			display: -webkit-box;
			background-color: #fff;
			/*padding: 10px 0;*/
		}

		.userinfo .userinfocol {
			/*-webkit-box-flex:1;*/
			padding: 10px 0;
			text-align: center;
			width: 25%;
			box-sizing: border-box;
		}

		.userinfo .userinfocol .info {
			font-size: 0.8em;
			color: #999;
		}

		.userinfo .userinfocol .info img {
			width: 2em;
		}

		.userinfo .userinfocol .num {
			padding-top: 5px;
		}
		/* 播放全部*/

		.playall {
			background-color: #f9f9f9;
		}

		.playall .egret-flex-item-arrow {
			-webkit-box-flex: 1;
			max-width: 2.0em;
			min-width: 2.0em;
			margin-right: 15px;
		}

		.playall .egret-flex-item-arrow img {
			max-width: none;
		}

		.playall .egret-flex-item-logo img {
			width: 1.5em;
			height: 1.5em;
		}
		/* egret item 抽象右部 */

		.egret-flex-item-abright {
			display: -webkit-box;
			-webkit-box-flex: 1;
			border-bottom: 1px solid #e0e0e0;
			-webkit-box-align: center;
			height: 4em;
		}
		/* musiclist 特殊样式 */

		.musiclist-item {
			height: 4em;
		}

		.musiclist-item .egret-flex-item-logo {
			text-align: center;
			font-size: 1.2em;
			color: #999999;
		}

		.musiclist-item .egret-flex-item-shelf .egret-flex-item-shelf01 {
			font-size: 1em;
		}

		.musiclist-item .egret-flex-item-arrow {
			max-width: 24px;
			min-width: 24px;
		}

		.musiclist-item .egret-flex-item-arrow img {
			max-width: none;
		}
		/* 弹出工具条 */

		.musiclist-item-tool {
			background-color: #303030;
			color: #fff;
			display: -webkit-box;
			padding: 0 10px;
			display: none;
		}

		.musiclist-item-tool .userinfocol {
			-webkit-box-flex: 1;
			text-align: center;
			padding: 5px 0;
		}

		.musiclist-item-tool .userinfocol .info img {
			width: 50%;
		}

		.musiclist-item-tool .userinfocol .num {
			color: #A8A8A8;
			font-size: 0.8em;
		}
		/* 悬浮 */

		.exitbtnhover {
			background-color: #d33a31;
			color: #fff;
		}

		.userinfo .toolhover {
			background-color: #e2e2e2;
		}

		.musiclist-item-tool .toolhover {
			background-color: #1d1d1d;
		}

		.allplayhover {
			background-color: #e2e2e2;
		}
	</style>
</head>

<body>
	<!-- 1 用户登录 -->
	<div id='ava' class="egret-flex-item musiclistprofile">
		<div class="egret-flex-item-logo">
			<img src="../../image/default.jpg" alt="" class="">
		</div>
		<div class="egret-flex-item-shelf">
			<div class="egret-flex-item-shelf01" style="font-size: 1em">
				加载中...
			</div>
			<span class="egret-flex-item-shelf02"> <img src="./image/musiclist/musiclistcreater.jpg" alt="" class="createrlogo">
					<div class="creatername">
						新感官
					</div>
					<div class="egret-flex-item-arrow">
						<img src="./image/musiclist/cm2_list_icn_arr.png" alt="" class="">
					</div> </span>
		</div>
	</div>
	<div class="userinfo">
		<div class="userinfocol01 userinfocol br" tapmode="toolhover" onclick="collectmusic(this)" data-click="0">
			<div class="info"><img src="./image/musiclist/musiclistcollect.png" alt="" class="collectmusic">
			</div>
			<div class="num">
				63
			</div>
		</div>
		<div class="userinfocol02 userinfocol br" tapmode="toolhover" onclick="openComm(0)">
			<div class="info"><img src="./image/musiclist/musiclistcommet.png" alt="">
			</div>
			<div class="num" id="CommCount">
				0
			</div>
		</div>
		<div class="userinfocol03 userinfocol br" tapmode="toolhover" onclick="openMusiclistshare()">
			<div class="info"><img src="./image/musiclist/musiclistshare.png" alt="">
			</div>
			<div class="num">
				分享
			</div>
		</div>
		<div class="userinfocol03 userinfocol" tapmode="toolhover" onclick="downloadAll()">
			<div class="info"><img src="./image/musiclist/musiclistdown.png" alt="">
			</div>
			<div class="num">
				下载
			</div>
		</div>
	</div>
	<!-- 2 播放全部 -->
	<div class="egret-flex-item isolateitem-bottom playall" tapmode="allplayhover" onclick="">
		<div class="egret-flex-item-logo">
			<img src="./image/musiclist/musiclistplay.png" alt="" class="">
		</div>
		<div class="egret-flex-item-shelf">
			<div class="egret-flex-item-shelf01">
				专辑<span id='Num' class="totalnum">共25首音乐</span>
			</div>
		</div>
		<div class="egret-flex-item-arrow">
			<img src="./image/musiclist/musiclistplayarrow.png" alt="" class="">
		</div>
	</div>
	<div id="list"></div>
	</div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/mm.js"></script>
<script type="text/javascript">
	var isopen

	function collectmusic(clicktoolitem) {
		var toolbarlist = document.getElementsByClassName('collectmusic')[0];
		var click = clicktoolitem.getAttribute("data-click");
		if (click == 0) {
			// 点开
			clicktoolitem.setAttribute("data-click", 1);
			toolbarlist.src = "./image/musiclist/musiclisttool01.png";
			api.toast({
				msg: '开发中...',
				duration: 1000,
				location: 'bottom'
			});
		} else {
			// 关闭
			clicktoolitem.setAttribute("data-click", 0);
			toolbarlist.src = "./image/musiclist/musiclistcollect.png";
			api.toast({
				msg: '开发中...',
				duration: 1000,
				location: 'bottom'
			});
		}
	}

	function openMusicPlay() {
		api.openWin({
			name: 'musicplay',
			url: 'musicplay.html',
			delay: 200
		});
	}

	function openComm(type) {
		if (!$api.getStorage('userinfo')) {
			api.toast({
				msg: '请先登陆'
			});
			return
		}
		var sid = api.pageParam.lid
		api.openWin({
			name: 'comm',
			url: '../../html/music/comm/head.html',
			opaque: true,
			vScrollBarEnabled: false,
			pageParam: {
				type: type,
				sid: sid
			}
		});
	}

	function openMusiclistshare() {
		var wx = api.require('wx');
		var tracksName = $api.getStorage('trackTitle');
		var thumb = $api.getStorage('trackThumb');
		//          获取专辑封面缓存
		api.imageCache({
			url: thumb
		}, function(ret, err) {
			if (ret) {
				var thumbb = ret.url
					//分享页面
				wx.shareWebpage({
					apiKey: '',
					scene: 'timeline',
					title: tracksName,
					description: '聆听音乐 感悟人生',
					thumb: thumbb,
					contentUrl: 'http://bbs.xggsj.com/'
				}, function(ret, err) {
					if (ret.status) {
						api.toast({
							msg: '分享成功'
						});
					} else {
						api.toast({
							msg: '取消分享'
						});
					}
				});
			} else {}
		});
		$api.rmStorage('trackTitle');
	}

	function downloadAll() {
		api.toast({
			msg: '因版权问题暂无法提供下载'
		});
		//          api.confirm({
		//              title : '下载',
		//              msg : '下载本歌单全部音乐？',
		//              buttons : ["确定", "取消"]
		//          }, function(ret, err) {
		//              if (ret.buttonIndex == 1) {
		//              } else {
		//              }
		//          });
	}

	//      function downloadMusic() {
	//          api.confirm({
	//              title : '下载',
	//              msg : '下载本首歌？',
	//              buttons : ["确定", "取消"]
	//          }, function(ret, err) {
	//              if (ret.buttonIndex == 1) {
	//              } else {
	//              }
	//          });
	//      }
	function expandlist(index, clickitem) {
		var toolbarlist = document.getElementsByClassName('musiclist-item-tool');
		var toolbarimg = document.getElementsByClassName('toobarimg');
		var clicktoolitem = toolbarlist[index];
		var click = clicktoolitem.getAttribute("data-click");
		// 复原其他tool，一次只打开一个tool
		for (var i = 0; i < toolbarlist.length; i++) {
			toolbarlist[i].setAttribute("data-click", 0);
			toolbarlist[i].style.display = 'none';
			toolbarimg[i].src = "./image/musiclist/musiclistmore.png";
		}
		if (click == 0) {
			// 点开
			clicktoolitem.setAttribute("data-click", 1);
			clickitem.src = "./image/musiclist/musiclistmore_prs.png";
			clicktoolitem.style.display = '-webkit-box';
		} else {
			// 关闭
			clicktoolitem.setAttribute("data-click", 0);
			clickitem.src = "./image/musiclist/musiclistmore.png";
			clicktoolitem.style.display = 'none';
		}
	}

	apiready = function() {
		initPage();
		var isopen = $api.getStorage('isopen');
		api.addEventListener({
			name: 'playNext'
		}, function(ret, err) {
			var arr = $api.getStorage('listm');
			var index_m = Number(ret.value.index) + 1
			if (index_m == arr.length) {
				var sid = arr[0].id

				api.sendEvent({
					name: 'songid',
					extra: {
						sid: sid,
						index: 0
					}
				});
				return
			}
			var sid = arr[index_m].id
			var audioPlayer = api.require('audioPlayer');
			audioPlayer.stop();
			api.sendEvent({
				name: 'songid',
				extra: {
					sid: sid,
					index: index_m
				}
			});
		});
		api.addEventListener({
			name: 'prev_b'
		}, function(ret, err) {
			var index_m = Number(ret.value.index) - 1
			if (index_m < 0) {
				api.sendEvent({
					name: 'firstsong'
				});
				return
			}
			var sid = arr[index_m].id
			var audioPlayer = api.require('audioPlayer');
			audioPlayer.stop();
			api.sendEvent({
				name: 'songid',
				extra: {
					sid: sid,
					index: index_m
				}
			});
		});
		api.setRefreshHeaderInfo({
			loadingImg: 'widget://image/refresh.png',
			visible: true,
			bgColor: '#f2f2f2',
			textColor: '#4d4d4d',
			textDown: '下拉刷新...',
			textUp: '松开刷新...',
			showTime: true
		}, function(ret, err) {
			initPage();
		});
	};

	function initPage() {
		uiloading()
		var mdata
		var lid = api.pageParam.lid
		api.setPrefs({
			key: 'mul',
			value: lid
		});
		// 读取缓存
		api.readFile({
			path: api.cacheDir + '/mlist/' + lid + '.json'

		}, function(ret, err) {
			if (ret.status) {
				mdata = $api.strToJson(ret.data);
				initlist(mdata, lid)
				getlistdata()

			} else {
				getlistdata()
			}
		}); //ss

	}

	//  初始化数据
	function getlistdata() {
		var lid = api.pageParam.lid
		api.ajax({
			url: musicUrl + lid + houZhui,
			cache: true,
			dataType: 'json'
		}, function(ret, err) {
			if (ret) {
				mdata = ret.result
				initlist(mdata, lid)
				api.writeFile({
					path: api.cacheDir + '/mlist/' + lid + '.json',
					data: mdata
				}, function(ret, err) {
					// api.toast({
					//     msg: ret,
					//     duration: 2000,
					//     location: 'bottom'
					// });

				});
			} else {
				// api.toast({
				// 	msg: '网络错误',
				// 	duration: 2000,
				// 	location: 'bottom'
				// });

				stoploading();
			}

		});

	}

	// 初始化页面
	function initlist(mdata, lid) {
		var html = ''
		var tracksName = mdata.name;
		var avatarUrl = mdata.creator.avatarUrl;
		var coverImgUrl = imageCache(mdata.coverImgUrl);
		var nickname = mdata.creator.nickname;
		id = mdata.id

		getCommCount(lid, 0)

		str1 = '<div class="egret-flex-item musiclistprofile"><div class="egret-flex-item-logo"><img src="' + coverImgUrl +
			'?param=140y140" alt="" onclick="photoV()"></div><div class="egret-flex-item-shelf"><div class="egret-flex-item-shelf01"style="font-size: 1em">' + tracksName.substr(0, 17) +
			'</div><span  class="egret-flex-item-shelf02"><img src="../../image/qq.png" alt="" class="createrlogo"><div class="creatername">新感官</div><div class="egret-flex-item-arrow"><img src="./image/musiclist/cm2_list_icn_arr.png" alt="" class=""></div> </span></div></div>';
		$api.byId('ava').innerHTML = str1;
		arr = mdata.tracks;
		$api.setStorage('listm', arr);
		var myobj = eval(arr);
		var len = myobj.length;
		$api.setStorage('lens', len);
		str4 = '<span class="totalnum">共' + len + '首音乐</span>';
		$api.byId('Num').innerHTML = str4;
		//
		var obj = $api.byId('list');
		//                  for (var i = 0; i < myobj.length; i++) {
		for (var i = 0; i < myobj.length; i++) {
			var bb = myobj[i].name;
			var position = myobj[i].no;
			var sid = myobj[i].id;
			var artists = myobj[i].artists[0].name
			var a = i;
			var n = i + 1;
			//                      var nType = thisItem.type;
			html += '<div class="egret-flex-item musiclist-item" > <div class="egret-flex-item-logo">' + n + '</div>';
			html += '<div class="egret-flex-item-abright"><div class="egret-flex-item-shelf" onclick="abc(' + sid + ',' + i + ')">';
			html += '<div class="egret-flex-item-shelf01">' + bb + '</div><div class="egret-flex-item-shelf02">';
			html += '' + artists + '</div></div><div class="egret-flex-item-arrow"><img src="./image/musiclist/musiclistmore.png" alt="" class="toobarimg"">';
			html += '</div></div></div><div class="musiclist-item-tool" >';
			html += '<div class="userinfocol" tapmode="toolhover" onclick="">';
			html += '<div class="info"><img src="./image/musiclist/musiclisttool01.png" alt=""></div>';
			html += '<div class="num">收藏</div></div><div class="userinfocol" tapmode="toolhover" onclick="downloadMusic()">';
			html += '<div class="info"><img src="./image/musiclist/musiclisttool02.png" alt=""></div>';
			html += '<div class="num">下载</div></div><div class="userinfocol" tapmode="toolhover" onclick="openMusiclistshare()">';
			html +=
				'<div class="info"><img src="./image/musiclist/musiclisttool03.png" alt=""></div><div class="num">分享</div></div><div class="userinfocol" tapmode="toolhover" onclick=""><div class="info"><img src="./image/musiclist/musiclisttool04.png" alt="">';
			html += '</div><div class="num">歌手</div></div><div class="userinfocol" tapmode="toolhover" onclick=""><div class="info"><img src="./image/musiclist/musiclisttool05.png" alt=""></div><div class="num">专辑</div></div></div>';
		}
		$api.html(obj, html);
		//                  api.hideProgress();
		stoploading();
		api.refreshHeaderLoadDone();

	}

	function playNext_f() {
		api.addEventListener({
			name: 'playNext'
		}, function(ret, err) {
			index_m = ret.value.index
			var arr = $api.getStorage('listm');
			var sid = arr[index_m + 1].id
			api.sendEvent({
				name: 'songid',
				extra: {
					sid: sid,
					index: index_m + 1
				}
			});
		});
	}

	function abc(el, i) {
		// var Idd = api.pageParam.name;
		$api.setStorage('name', 1);
		$api.setStorage('idi', i);
		$api.setStorage('listopen', 1);
		if (!isopen) {
			api.openWin({
				name: 'nww',
				url: '../../html/music/bo_head.html',
				// delay: 300,
				slidBackEnabled: false,
				animation: {
					type: "push", //动画类型（详见动画类型常量）
					subType: "from_bottom", //动画子类型（详见动画子类型常量）
					duration: 400 //动画过渡时间，默认300毫秒
				},
				pageParam: {
					sid: el,
					index: i,
				}
			});
			setTimeout(function() {
				api.sendEvent({
					name: 'songid',
					extra: {
						sid: el,
						index: i
					}
				}), 600
			});
		} else {
			api.openWin({
				name: 'nww',
			});
			api.sendEvent({
				name: 'songid',
				extra: {
					sid: el,
					index: i
				}
			})
		}
	};

	function getCommCount(id, type) {

		api.ajax({
			url: hostUrl + '/comm.php',
			method: 'get',
			cache: false,
			timeout: 30,
			dataType: 'json',
			data: {
				values: {
					ID: id,
					type: type
				}
			}
		}, function(ret, err) {
			if (ret) {
				var cout = ret.length

				$api.text($api.byId('CommCount'), cout);
			} else {


			}
		});
	}
</script>

</html>
