<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<title>title</title>
		<link rel="stylesheet" type="text/css" href="../../../css/Hui.css"/>
		<style>
			body {
			}
		</style>
	</head>
	<body>
		<div class="H-width-80-percent  ">
			<img id="img1"   src=""/ style="width: 100%; max-height: 600px;">
			<textarea placeholder="聆听音乐  感悟人生" id="feed_text" style="height:100px;width: 100%;line-height:24px;"></textarea>
			<!--<input id="feed_text" placeholder="聆听音乐 感悟人生"class="H-theme-border-color5" style="height:100px;width: 100%;line-height:24px;font-size: 18px"> </input>-->
			<button onclick="addpic()" class="  H-vertical-middle H-button H-font-size-15 H-outline-none H-padding-vertical-both-5 H-padding-horizontal-both-20 H-theme-background-color5 H-theme-font-color-white H-theme-border-color5 H-theme-border-color5-click H-theme-background-yellow-click H-theme-font-color1-click H-border-radius-3" style="min-width: 70px; margin-left: 3px; margin: 2px auto">
				发布
			</button>
		</div>
	</body>
	<script type="text/javascript" src="../../../script/api.js"></script>
	<script type="text/javascript" src="../../../script/H.js"></script>
	<script type="text/javascript">
		//		var img1 = 'http://p4.music.126.net/NLIxnlNPSPk3GFacJg01kA==/17814287393396301.jpg';
		var type = 1;
		function addpic() {
			var text1 = $api.val($api.byId("feed_text"));
			var img1 = api.pageParam.name
			api.showProgress({
				title : ' 上传中...',
				text : '先喝杯茶...',
				modal : false
			}), api.ajax({
				timeout : 300,
				method : 'post',
				url : hostUrl + '/upload.php',
				data : {
					files : {
						upfile : img1
					},
				},
				dataType : 'text',
			}, function(ret, err) {
				var aa = hostUrl + '/' + ret
				api.hideProgress();
				api.getPrefs({
					key : 'user'
				}, function(ret, err) {
					var username = ret.value;
					var url = hostUrl + '/addpic.php';
					if (ret) {
						api.ajax({
							url : url,
							method : 'post',
							dataType : 'text',
							data : {
								values : {
									user : username,
									type : type,
									text : text1,
									img : aa
								},
							}
						}, function(ret, err) {
							if (ret == 1) {
								api.toast({
									msg : '发布成功'
								});
								api.closeWin({
								});
							} else {
								api.alert({
								}, function(ret, err) { msg:'发布失败'
								});
								api.closeWin({
								});
							}
						});
					} else {
						api.alert({
							msg : JSON.stringify(err)
						});
					}
				});
			});
		}

		apiready = function() {
			$api.attr($api.byId('img1'), 'src', api.pageParam.name);
		};
		/**
		 * 获取头像
		 * 周枫
		 * 2016.1.16
		 */
		function getPicture() {
			isOnLineStatus(function(is_true, line_type) {
				if (is_true) {
					if (line_type == 'wifi' || line_type == '4g') {
						api.confirm({
							title : "提示",
							msg : "您需要如何选择自己的头像？",
							buttons : ["现在照", "相册选", "取消"]
						}, function(ret, err) {
							//定义图片来源类型
							var sourceType;
							if (1 == ret.buttonIndex) {/* 打开相机*/
								sourceType = "camera";
								openPicture(sourceType);
							} else if (2 == ret.buttonIndex) {
								sourceType = "album";
								openPicture(sourceType);
							} else {
								return;
							}
						});
					} else {
						api.confirm({
							title : "提示",
							msg : "您当前正在使用" + line_type + "网络，建议您在wifi网络下使用，是否继续？",
							buttons : ["继续", "取消"]
						}, function(ret, err) {
							var sourceType;
							if (1 == ret.buttonIndex) {
								api.confirm({
									title : "提示",
									msg : "您需要如何选择自己的头像？",
									buttons : ["现在照", "相册选", "取消"]
								}, function(ret, err) {
									//定义图片来源类型
									var sourceType;
									if (1 == ret.buttonIndex) {/* 打开相机*/
										sourceType = "camera";
										openPicture(sourceType);
									} else if (2 == ret.buttonIndex) {
										sourceType = "album";
										openPicture(sourceType);
									} else {
										return;
									}
								});
							} else {
								return;
							}
						});
					}
				} else {
					api.toast({
						msg : '请连接网络后使用当前功能~'
					});
				}
			});
		}

		/**
		 * 选取图片
		 * 周枫
		 * 2016.1.16
		 */
		function openPicture(sourceType) {
			isOnLineStatus(function(is_true, line_type) {
				var q = 50;
				if (line_type == 'wifi') {
					q = 80;
				} else {
					q = 30;
				}
				//获取一张图片
				api.getPicture({
					sourceType : sourceType,
					encodingType : 'png',
					mediaValue : 'pic',
					//返回数据类型，指定返回图片地址或图片经过base64编码后的字符串
					//base64:指定返回数据为base64编码后内容,url:指定返回数据为选取的图片地址
					destinationType : 'url',
					//是否可以选择图片后进行编辑，支持iOS及部分安卓手机
					allowEdit : false,
					//图片质量，只针对jpg格式图片（0-100整数）,默认值：50
					quality : q,
					//                targetWidth : 100,
					//                targetHeight : 1280,
					saveToPhotoAlbum : true
				}, function(ret, err) {
					if (ret) {
						/*
						 * data:"",                //图片路径
						 base64Data:"",          //base64数据，destinationType为base64时返回
						 */
						var img_url = ret.data;
						if (img_url != "") {
							//打开裁剪frame
							//							openImageClipFrame(img_url);
							$api.attr($api.byId('img1'), 'src', img_url);
						}
					}
				});
			});
		}

		function openImageClipFrame(img_src) {
			api.openFrame({
				name : 'tu',
				scrollToTop : true,
				allowEdit : true,
				url : '../tu.html',
				rect : {
					x : 0,
					y : 0,
					w : api.winWidth,
					h : api.winHeight,
				},
				animation : {
					type : "reveal", //动画类型（详见动画类型常量）
					subType : "from_right", //动画子类型（详见动画子类型常量）
					duration : 300
				},
				pageParam : {
					img_src : img_src
				},
				vScrollBarEnabled : false,
				hScrollBarEnabled : false,
				//页面是否弹动 为了下拉刷新使用
				bounces : false
			});
		}

		function isOnLineStatus(callback) {
			var s = api.connectionType;
			s = s.toLowerCase();
			if (s == 'wifi' || s == '3g' || s == '4g' || s == '2g') {
				callback(true, s);
			} else {
				callback(false, s);
			}
		}

		function upload(file) {
		}
	</script>
</html>